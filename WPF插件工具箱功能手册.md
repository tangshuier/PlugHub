# WPF插件工具箱功能手册

## 1. 系统概述

WPF插件工具箱是一个基于WPF的插件管理系统，支持热插拔插件、插件依赖管理、插件UI窗口和调试功能。本手册详细介绍工具箱的核心功能、使用方法和插件开发指南。

### 1.1 核心特性

- ✅ **热插拔插件**：支持在运行时加载、卸载和重新加载插件
- ✅ **插件依赖管理**：支持插件间的依赖关系
- ✅ **插件UI多标签页支持**：每个插件可提供独立的用户界面，支持多标签页切换
- ✅ **自动目录监听**：自动检测插件目录变化，实时重新加载插件
- ✅ **专门的调试窗口**：提供详细的调试信息和日志记录
- ✅ **完整的API支持**：提供文件操作、窗口创建、日志记录等API
- ✅ **插件生命周期管理**：支持插件的初始化、激活、停用和释放
- ✅ **主题同步功能**：插件可以同步工具箱的主题

### 1.2 系统架构

```
┌───────────────────────────────────────────────────────────────────┐
│                     WPF插件工具箱主应用                          │
├─────────────────┬───────────────────┬───────────────────────────┤
│  插件管理器      │    插件加载器      │        服务层             │
│  PluginManager  │   PluginLoader     │   LogService              │
└─────────────────┴───────────────────┴───────────────────────────┘
                              ▲
                              │
┌───────────────────────────────────────────────────────────────────┐
│                           插件目录                                │
├─────────────────┬───────────────────┬───────────────────────────┤
│   插件1          │     插件2         │         依赖插件          │
│  Plugin1.dll     │   Plugin2.dll     │    Dependency1.dll        │
└─────────────────┴───────────────────┴───────────────────────────┘
```

## 2. 核心功能

### 2.1 插件管理

#### 2.1.1 插件加载

- **自动加载**：应用程序启动时自动加载 `Plugins` 目录中的所有插件
- **手动加载**：通过界面按钮手动加载插件
- **重新加载**：支持重新加载所有插件，用于更新插件或修复问题

#### 2.1.2 插件卸载

- **单个卸载**：暂未实现，仅支持卸载所有插件
- **全部卸载**：支持一次性卸载所有插件
- **资源清理**：自动调用插件的 `Dispose` 方法，确保资源正确释放

#### 2.1.3 插件激活与停用

- **激活插件**：调用插件的 `Activate` 方法，启动插件功能
- **停用插件**：调用插件的 `Deactivate` 方法，暂停插件功能
- **状态管理**：跟踪插件的激活状态，确保功能正确切换

### 2.2 依赖管理

#### 2.2.1 依赖类型

| 类型 | 说明 | 处理方式 |
|------|------|----------|
| **必要依赖** | 插件必须依赖，缺失则插件无法加载 | 缺失时插件初始化失败 |
| **非必要依赖** | 插件可选依赖，缺失不影响插件加载 | 缺失时功能受限，但插件仍可使用 |

#### 2.2.2 依赖检测

- **启动时检测**：应用程序启动时检测插件依赖关系
- **运行时检测**：插件可以在运行时检测依赖是否存在
- **依赖优先级**：依赖插件优先于普通插件加载

#### 2.2.3 依赖使用

- **依赖获取**：插件可通过 `GetDependency` 获取依赖实例
- **依赖检查**：插件可通过 `HasDependency` 检查依赖是否存在
- **依赖隔离**：依赖仅对请求的插件可见，保证插件间的隔离性

### 2.3 目录监听

#### 2.3.1 自动检测机制

- **文件系统监听**：使用 `FileSystemWatcher` 监听 `Plugins` 目录
- **事件响应**：当检测到 `.dll` 文件变化（创建、修改、删除）时触发
- **延迟加载**：添加 500ms 延迟，确保文件操作完成后再重新加载

#### 2.3.2 变化类型支持

- ✅ **文件创建**：新增插件文件时自动加载
- ✅ **文件修改**：修改插件文件时自动重新加载
- ✅ **文件删除**：删除插件文件时自动卸载

### 2.4 插件API

#### 2.4.1 基础信息

- **PluginId**：获取插件唯一标识符
- **PluginName**：获取插件名称
- **PluginPath**：获取插件文件路径

#### 2.4.2 日志记录

| 方法 | 说明 | 参数 |
|------|------|------|
| `Debug` | 记录调试信息 | message: 日志消息<br>data: 附加数据（可选） |
| `Info` | 记录普通信息 | message: 日志消息<br>data: 附加数据（可选） |
| `Warn` | 记录警告信息 | message: 日志消息<br>data: 附加数据（可选） |
| `Error` | 记录错误信息 | message: 日志消息<br>exception: 异常对象（可选） |

#### 2.4.3 文件操作

| 方法 | 说明 | 返回值 |
|------|------|--------|
| `ReadFileAsync` | 异步读取文件内容 | `Task<string>` |
| `WriteFileAsync` | 异步写入文件内容 | `Task` |
| `CreateFileAsync` | 异步创建文件 | `Task` |
| `FileExists` | 检查文件是否存在 | `bool` |
| `DeleteFileAsync` | 异步删除文件 | `Task` |
| `CreateDirectoryAsync` | 异步创建目录 | `Task` |
| `DirectoryExists` | 检查目录是否存在 | `bool` |
| `SearchFiles` | 检索文件 | `IEnumerable<string>` |

#### 2.4.4 窗口操作

| 方法 | 说明 |
|------|------|
| `CreateWindow` | 创建新窗口 |
| `ShowWindow` | 显示窗口 |
| `CloseWindow` | 关闭窗口 |

#### 2.4.5 插件操作

| 方法 | 说明 | 返回值 |
|------|------|--------|
| `GetDependency` | 获取依赖插件 | `IDependency?` |
| `HasDependency` | 检查依赖是否存在 | `bool` |

## 3. 界面功能

### 3.1 主界面布局

```
┌───────────────────────────────────────────────────────────────────┐
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │                     工具栏                                  │  │
│  │  导入插件   打开调试窗口   设置                              │  │
│  └─────────────────────────────────────────────────────────────┘  │
│  ┌─────────────────┬───────────────────────────────────────────┐  │
│  │   插件列表      │                   工作区                  │  │
│  │                 │    ┌─────────────────────────────────────┐  │
│  │   插件1         │    │  插件1的标签页  插件2的标签页 ...    │  │
│  │   插件2         │    ├─────────────────────────────────────┤  │
│  │   ...           │    │  插件1的主视图                       │  │
│  │                 │    │                                     │  │
│  └─────────────────┴────┴─────────────────────────────────────┘  │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │                   调试信息区域                               │  │
│  │  [日志信息...]                                             │  │
│  └─────────────────────────────────────────────────────────────┘  │
└───────────────────────────────────────────────────────────────────┘
```

### 3.2 工具栏功能

| 按钮 | 功能 | 快捷键 |
|------|------|--------|
| 导入插件 | 导入插件包 | 无 |
| 打开调试窗口 | 打开独立的调试窗口 | 无 |
| 设置 | 打开设置窗口 | 无 |

### 3.3 插件标签页

| 功能 | 说明 |
|------|------|
| 多标签页支持 | 每个插件打开时创建一个独立标签页 |
| 标签页切换 | 点击标签页切换不同插件 |
| 标签页关闭 | 点击标签页右侧的关闭按钮关闭标签页 |
| 设置标签页 | 设置窗口也在标签页中显示 |

### 3.3 插件列表

- **显示内容**：插件名称、版本、描述
- **交互功能**：选择插件后在工作区显示插件主视图
- **更新机制**：插件加载/卸载时自动更新列表

### 3.4 插件工作区

- **动态内容**：根据选择的插件显示对应的主视图
- **空状态提示**：未选择插件时显示提示信息
- **自适应布局**：适应主窗口大小变化

### 3.5 调试信息区域

- **实时日志**：显示应用程序和插件的日志信息
- **日志级别**：支持调试、信息、警告、错误级别
- **自动滚动**：新日志自动滚动到底部
- **清空功能**：可手动清空调试信息

### 3.6 调试窗口

- **独立窗口**：可拖动、调整大小
- **日志过滤**：可根据日志级别过滤
- **日志保存**：可将日志保存到文件
- **插件信息**：显示已加载插件和依赖的详细信息

## 4. 插件开发

### 4.1 插件类型

#### 4.1.1 Plugin（普通插件）

- **用途**：提供独立功能的插件
- **特点**：有独立的用户界面，可被用户选择和使用
- **接口**：实现 `IPlugin` 接口

#### 4.1.2 Dependency（依赖插件）

- **用途**：为其他插件提供API支持
- **特点**：没有用户界面，仅提供功能接口
- **接口**：实现 `IDependency` 接口

### 4.2 插件生命周期

#### 4.2.1 生命周期流程

1. **Initialize** → 2. **Activate** → 3. **Deactivate** → 4. **Dispose**

#### 4.2.2 生命周期方法

| 方法 | 调用时机 | 职责 |
|------|----------|------|
| `Initialize` | 插件加载时 | - 获取API实例<br>- 初始化资源<br>- 检查依赖 |
| `Activate` | 插件被选中时 | - 启动插件功能<br>- 注册事件<br>- 开始数据采集 |
| `Deactivate` | 插件被取消选择时 | - 暂停插件功能<br>- 取消事件注册<br>- 停止数据采集 |
| `Dispose` | 插件卸载时 | - 释放资源<br>- 关闭连接<br>- 保存状态 |

### 4.3 插件开发流程

#### 4.3.1 创建插件项目

1. **创建类库项目**：使用 .NET 9.0-windows 框架
2. **添加引用**：
   - `WPFPluginToolbox.Core.dll`

#### 4.3.2 实现插件接口

```csharp
public class MyPlugin : IPlugin
{
    // 插件基本信息
    public string Id { get; } = "MyPlugin";
    public string Name { get; } = "我的插件";
    public string Description { get; } = "这是一个示例插件";
    public string Version { get; } = "1.0.0";
    public PluginType Type { get; } = PluginType.Plugin;

    // 生命周期方法
    public void Initialize(IPluginAPI pluginApi) { /* 初始化插件 */ }
    public void Activate() { /* 激活插件 */ }
    public void Deactivate() { /* 停用插件 */ }
    public void Dispose() { /* 释放资源 */ }

    // UI方法
    public UserControl GetMainView() { /* 返回插件主视图 */ }
}
```

#### 4.3.3 开发插件UI

1. **创建UserControl**：添加 `UserControl` 文件
2. **设计UI**：使用XAML设计插件界面
3. **绑定数据**：使用数据绑定或代码隐藏实现交互逻辑
4. **返回视图**：在 `GetMainView()` 方法中返回UI控件实例
   - **最佳实践**：每次调用都创建新的视图实例，而不是返回单例
   - **原因**：WPF中的UI元素只能有一个父元素，当视图从UI中移除后不能再添加回UI
   - **示例**：`return new MyPluginView();`

#### 4.3.4 构建与部署

1. **构建项目**：生成 `.dll` 文件
2. **部署插件**：将 `.dll` 文件复制到 `Plugins` 目录
3. **测试插件**：启动应用程序或点击「重新加载插件」按钮

### 4.4 插件API使用

#### 4.4.1 日志记录示例

```csharp
// 记录不同级别的日志
_pluginApi.Debug("调试信息");
_pluginApi.Info("普通信息");
_pluginApi.Warn("警告信息");
_pluginApi.Error("错误信息", exception);
```

#### 4.4.2 文件操作示例

```csharp
// 异步写入文件
await _pluginApi.WriteFileAsync("test.txt", "Hello from plugin!");

// 异步读取文件
string content = await _pluginApi.ReadFileAsync("test.txt");

// 检查文件是否存在
if (_pluginApi.FileExists("test.txt"))
{
    _pluginApi.Info("文件存在");
}
```

#### 4.4.3 窗口操作示例

```csharp
// 创建非模态窗口
var window = _pluginApi.CreateWindow("我的窗口", new MyWindowView());
_pluginApi.ShowWindow(window);

// 创建模态窗口
var dialog = _pluginApi.CreateWindow("对话框", new DialogView(), isModal: true);
dialog.ShowDialog();
```

#### 4.4.4 依赖管理示例

```csharp
// 检查必要依赖
if (!_pluginApi.HasDependency("RequiredDependency"))
{
    throw new Exception("缺少必要依赖");
}

// 获取依赖实例
var dependency = _pluginApi.GetDependency("OptionalDependency");
if (dependency != null)
{
    // 使用依赖功能
}
```

## 5. 系统配置

### 5.1 插件目录

- **默认目录**：应用程序运行目录下的 `Plugins` 文件夹
- **自定义目录**：可通过 `PluginManager.Initialize(string pluginsDirectory)` 自定义
- **目录结构**：插件及其依赖的 `.dll` 文件直接放在 `Plugins` 目录下

### 5.2 配置文件

- **应用配置**：使用 `App.config` 存储应用程序配置
- **插件配置**：每个插件可在 `Plugins` 目录下创建自己的配置文件
- **配置管理**：插件可通过文件操作API读写配置文件

### 5.3 日志配置

- **日志级别**：默认为所有级别，可通过代码过滤
- **日志输出**：同时输出到调试信息区域和调试窗口
- **日志持久化**：可通过调试窗口将日志保存到文件

## 6. 最佳实践

### 6.1 插件设计

- **单一职责**：每个插件只负责一个功能领域
- **松耦合**：插件之间通过API交互，避免直接依赖
- **可扩展**：设计时考虑未来扩展需求
- **可测试**：便于单元测试和集成测试
- **文档完善**：提供清晰的文档和示例

### 6.2 性能优化

- **异步处理**：使用异步API处理耗时操作
- **延迟初始化**：只在需要时初始化资源
- **资源管理**：及时释放资源，实现 `IDisposable` 接口
- **UI优化**：使用虚拟化列表、数据模板等优化UI性能

### 6.3 安全性

- **最小权限**：只请求必要的API访问权限
- **输入验证**：验证所有用户输入
- **异常处理**：处理所有异常，避免崩溃
- **资源保护**：不修改工具箱核心文件

### 6.4 依赖管理

- **明确依赖关系**：清晰定义插件的依赖关系
- **版本兼容**：确保依赖版本兼容性
- **依赖隔离**：避免依赖冲突
- **备选方案**：为可选依赖提供备选功能

## 7. 故障排除

### 7.1 常见问题

| 问题 | 可能原因 | 解决方案 |
|------|----------|----------|
| 插件无法加载 | - 依赖缺失<br>- 代码错误<br>- 接口实现不正确 | - 检查依赖是否存在<br>- 查看调试窗口的错误信息<br>- 确保正确实现了IPlugin或IDependency接口 |
| 插件UI无法显示 | - `GetMainView()`返回null<br>- UI控件有错误 | - 确保`GetMainView()`返回有效的`UserControl`<br>- 检查UI控件的代码和XAML |
| 插件崩溃 | - 未处理异常<br>- 资源泄漏 | - 添加异常处理<br>- 正确实现`Dispose()`方法 |
| 依赖无法获取 | - 依赖ID错误<br>- 依赖未正确实现 | - 检查依赖ID是否正确<br>- 确保依赖正确实现了IDependency接口 |

### 7.2 调试技巧

1. **查看调试信息**：在主界面或调试窗口中查看日志信息
2. **添加详细日志**：在关键位置添加日志记录
3. **使用Visual Studio调试**：附加到工具箱进程调试插件
4. **检查事件查看器**：查看应用程序事件日志
5. **验证插件目录**：确保插件文件在正确的目录中

## 8. 版本历史

| 版本 | 日期 | 主要变更 |
|------|------|----------|
| 1.0.0 | 2025-12-12 | 初始版本，包含核心插件系统 |
| 1.1.0 | 2025-12-13 | 新增插件依赖管理功能 |
| 1.2.0 | 2025-12-14 | 新增目录监听功能，自动重新加载插件 |
| 1.3.0 | 2025-12-15 | 完善插件API，新增文件操作和窗口操作功能 |
| 1.4.0 | 2025-12-16 | 新增调试窗口，优化日志记录功能 |
| 1.5.0 | 2025-12-17 | 完善插件生命周期管理，优化界面交互 |
| 1.6.0 | 2025-12-18 | 移除MEF框架依赖，使用AssemblyLoadContext实现插件加载 |
| 1.7.0 | 2025-12-26 | 新增主题相关功能，更新插件API文档 |

## 9. 开发团队

- **开发人员**：[开发团队名称]
- **联系邮箱**：[邮箱地址]
- **GitHub仓库**：[GitHub链接]
- **文档地址**：[文档链接]

## 10. 许可证

本项目采用 [MIT License](https://opensource.org/licenses/MIT) 许可证。

---

**WPF插件工具箱开发团队**
**最后更新日期：2025-12-26**